# Debug Adapter Protocol (DAP) Implementation

## 概要

CASL2/COMET2エミュレータにDebug Adapter Protocol (DAP)を実装し、エディタやIDEからのステップ実行などのデバッグ機能を実現しました。

## 実装内容

### 1. コマンドラインオプション

新しい `-dap` オプションを追加しました：

```bash
./c2c2 -dap <port>
```

このコマンドでDAPサーバーが指定されたTCPポート上で起動し、デバッグセッションを待機します。

### 2. DAPプロトコル実装

以下のDAPメッセージとリクエストをサポート：

#### 初期化と設定
- `initialize`: デバッグアダプタの初期化
- `configurationDone`: 設定完了の通知

#### プログラム制御
- `launch`: CASL2プログラムのロードと起動
- `attach`: プロセスへのアタッチ（未サポート）
- `disconnect`: デバッグセッションの終了
- `terminate`: プログラムの強制終了

#### 実行制御
- `continue`: プログラムの継続実行
- `next`: 次の命令へステップ実行（ステップオーバー）
- `stepIn`: 命令内へステップイン（COMET2では`next`と同じ）
- `stepOut`: 関数から抜けるまで実行
- `pause`: 実行の一時停止

#### ブレークポイント
- `setBreakpoints`: ソースコード行へのブレークポイント設定
- ブレークポイントは実際のメモリアドレスにマップされ、実行時に検証されます

#### 状態検査
- `threads`: スレッド一覧の取得（常に単一スレッド）
- `stackTrace`: スタックトレースの取得
- `scopes`: 変数スコープの取得（レジスタスコープ）
- `variables`: 変数値の取得（PC, FR, GR0-GR7, SP）

### 3. 技術的詳細

#### プロトコル通信
- TCPソケット上でJSON-RPCプロトコルを使用
- Content-Lengthヘッダーを持つHTTPスタイルのメッセージフォーマット
- シーケンス番号による要求/応答のマッチング

#### スレッドセーフティ
- mutexを使用してシーケンス番号生成を保護
- 複数の同時デバッグセッションをサポート（各接続は独立）

#### メモリとソースコードのマッピング
- アセンブラの`AssemblerState`を活用してソース行とメモリアドレスをマッピング
- ブレークポイント設定時にソース行をメモリアドレスに変換

### 4. 標準入出力の保持

DAPサーバーモードでも、標準入出力はIN/OUT命令のために確保されています。デバッグプロトコルはTCPソケット経由で処理され、プログラムのI/O操作とは分離されています。

## テスト

### テストカバレッジ

6つの包括的なテストケースを実装：

1. `TestDAPProtocolBasics`: 基本的なプロトコルメッセージ処理
2. `TestDAPLaunch`: プログラムの起動
3. `TestDAPStepExecution`: ステップ実行
4. `TestDAPBreakpoints`: ブレークポイント機能
5. `TestDAPVariables`: 変数検査
6. `TestDAPDisconnect`: 切断処理

すべてのテストが成功：
```
PASS
coverage: 24.9% of statements
ok  	github.com/f0reachARR/casljs	2.806s
```

### 既存機能の互換性

既存の28個のサンプルテストすべてが引き続き成功し、通常の実行モードに影響がないことを確認しました。

### セキュリティスキャン

CodeQLによるセキュリティスキャンでアラートなし：
```
Analysis Result for 'go'. Found 0 alerts:
- **go**: No alerts found.
```

## ファイル構成

### 新規ファイル
- `dap.go` (637行): DAP実装のコア
- `dap_test.go` (526行): 包括的なテストスイート
- `examples/README.md`: DAP使用例とドキュメント
- `examples/vscode-launch.json`: VS Code設定例
- `examples/simple_add.cas`: デバッグ用サンプルプログラム

### 変更ファイル
- `main.go`: `-dap`オプションの追加とDAPサーバー起動処理
- `README.md`: DAP機能の説明を追加

## 使用例

### 1. DAPサーバーの起動

```bash
./c2c2 -dap 4711
```

### 2. エディタからの接続

VS Codeなどのエディタから、DAP対応の拡張機能を使用してポート4711に接続します。

### 3. デバッグセッション

1. ブレークポイントをソースコードに設定
2. デバッグを開始
3. ステップ実行、変数検査、継続実行などの操作が可能

## 設計判断

### TCPベースの通信
リモートデバッグセッションを可能にするため、TCPソケットを使用しました。

### 最小限の変更
既存のコードへの影響を最小限に抑えるため、新しいファイルに実装を分離しました。

### プロトコル準拠
Microsoft のDebug Adapter Protocol仕様に準拠し、既存のDAP対応ツールとの互換性を確保しました。

## 今後の拡張可能性

- より詳細なブレークポイント条件（条件付きブレークポイント）
- メモリビューアー機能
- 実行履歴の記録と再生
- マルチスレッドサポート（将来的な拡張時）

## まとめ

この実装により、CASL2/COMET2プログラムを最新のIDEやエディタで効率的にデバッグできるようになりました。標準的なDAPプロトコルを使用することで、VS Code、Eclipse、IntelliJなど様々な開発環境からのサポートが可能です。
